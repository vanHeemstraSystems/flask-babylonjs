## 400 - Step 03: Adding Flask-Migrate to Your Application

In this step, you will modify your ```flask_app/app/__init__.py``` application file to add Flask-Migrate and use it to manage your Flask-SQLAlchemy database.

```
#!/usr/bin/env python
from flask_migrate import Migrate
...
```
flask_app/app/\_\_init__.py

You import the ```Migrate``` class from the ```flask_migrate``` package.

After the db declaration, you use the Migrate class to initiate a migration instance called ```migrate```.

Pass ```migrate``` to the Flask ```app``` instance and the ```db``` database instance,like so:

```
...
from flask_migrate import Migrate
... 
    ##
    # Migrate database
    ##

    migrate = Migrate(app,db)
...
```
flask_app/app/\_\_init__.py

Flask-Migrate provides a ```flask db``` command helper to manage your database.

To finish setting up Flask-Migrate and add support to your current project, use the following command in your flask_app directory:

```
 (.venv) flask_app $ flask db init
```

You will receive output similar to the following:

```
  Creating directory '/usr/local/opt/code/flask-babylonjs/flask_app/migrations' ...  done
  Creating directory '/usr/local/opt/code/flask-babylonjs/flask_app/migrations/versions' ...  done
  Generating /usr/local/opt/code/flask-babylonjs/flask_app/migrations/script.py.mako ...  done
  Generating /usr/local/opt/code/flask-babylonjs/flask_app/migrations/env.py ...  done
  Generating /usr/local/opt/code/flask-babylonjs/flask_app/migrations/README ...  done
  Generating /usr/local/opt/code/flask-babylonjs/flask_app/migrations/alembic.ini ...  done
  Please edit configuration/connection/logging settings in '/usr/local/opt/code/flask-babylonjs/flask_app/migrations/alembic.ini' before proceeding.
```

This creates a new migrations directory inside your ```flask_app``` folder, where all the migration scripts that manage your migrations will be stored.

If you are familiar with Alembic and want to add advanced configurations to your database migration system, you can modify the generated ```migrations/alembic.ini``` file. For our purposes, we will leave it as is.

**NOTE**: The ```migrations``` directory contains files that manage your app’s database migrations, and they must be added to your version control repository with the rest of your app’s code.

With Flask-Migrate connected to your application, you will perform an initial database migration. Using the ```User``` class will create the ```user``` table you declared earlier.

## Creating the User Table using a Migration Script

You will now perform your first migration, creating your database’s ```user``` table.

In your ```flask_app``` directory, run the following command. This flask db migrate command detects all the new tables or modifications you perform on your Flask-SQLAlchemy database models.

The ```-m``` flag allows you to specify a short message describing the modification you performed:

```
(.venv) flask_app $ flask db migrate -m "initial migration"
```

You will receive the following output:

```
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'user'
  Generating /usr/local/opt/code/flask-babylonjs/flask_app/migrations/versions/8048ee3cbab8_initial_migration.py ...  done
```

Because our database has not been created yet, this output informs you that a new table called ```user``` was detected, and a migration script called 8048ee3cbab8_initial_migration.py was created inside a directory called ```versions```, where all different migration versions are stored.

The 8048ee3cbab8 part in the migration script’s file name is a random ID generated to identify different migrations so that it will be different for you.

To understand how a migration script works, open yours with the following command. Make sure you replace 8048ee3cbab8 with the ID that was generated for you and that you are in your flask_app root directory:

```
(.venv) flask_app $ nano migrations/versions/8048ee3cbab8_initial_migration.py
```

Aside from internal imports and a setup, this initial migration script will have two main functions similar to the following:

```
"""initial migration

Revision ID: 8048ee3cbab8
Revises: 
Create Date: 2024-10-15 14:59:54.972631

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '8048ee3cbab8'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('user',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('username', sa.String(length=100), nullable=False),
    sa.Column('email', sa.String(length=120), nullable=False),
    sa.Column('password_hash', sa.String(length=128), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email'),
    sa.UniqueConstraint('username')
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('user')
    # ### end Alembic commands ###
```
flask_app/migrations/versions/8048ee3cbab8_initial_migration.py

- The ```upgrade()``` function changes the database based on the modifications detected by the flask db migrate command. In this case, a new table called ```user``` was detected, so the upgrade() function creates the new table with the columns specified in the ```User()``` database model you declared in the ```flask_app/app/models/user.py``` file.

- The ```downgrade()``` function removes the changes and restores the state of the database as it was before upgrading. In this example, the previous state is restored by deleting the ```user``` table that will be created by the upgrade() function.

**Note**: Keep in mind that migration scripts are automatically generated code, which may have some errors depending on the complexity of the changes you perform before the migration. Therefore, you must carefully read and adjust your migration scripts to ensure accuracy and proper execution.

With the migration script ready, you can now use it to perform an initial upgrade. This will create the ```flask_app/instance/app.db``` database file and the ```user``` table. To do this, run the following command in your ```flask_app``` directory:

```
(.venv) flask_app $ flask db upgrade
```

The output will be similar to the following:

```
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 8048ee3cbab8, initial migration
```

This informs you that the upgrade was successfully executed.

A new ```app.db``` database file will be added to your ```instance``` folder inside your ```flask_app``` directory.

**NOTE**: The first migration is equivalent to using ```db.create_all()``` in the Flask shell.

If you introduce Flask-Migrate into an existing project with an existing database, then the ```flask db upgrade``` will fail because a database file already exists. In that case, use ```flask db stamp``` to mark the database as upgraded instead of ```flask db upgrade```.

With the database and ```user``` table created, you can now add a few users to your database. You’ll do this next.

## Populating the Database

MORE